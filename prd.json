[
  {
    "category": "functional",
    "description": "Call v2 provider API and log raw response to inspect variant object structure",
    "steps": [
      "Read SDK types at node_modules/@opencode-ai/sdk/dist/v2/gen/types.gen.d.ts",
      "Found Model type at lines 1636-1702 with variants?: { [key: string]: { [key: string]: unknown } }",
      "Found Provider type at lines 1703-1715 with models: { [key: string]: Model }"
    ],
    "passes": true,
    "notes": "SDK types document the variant structure. Model.variants is an optional object keyed by variant name with arbitrary config values."
  },
  {
    "category": "functional",
    "description": "Document which fields exist on variant objects (disabled, description, etc.)",
    "steps": [
      "Read ProviderConfig type at lines 1190-1273 in types.gen.d.ts",
      "Config-side variant type: { disabled?: boolean; [key: string]: unknown }",
      "API-side Model.variants type: { [key: string]: { [key: string]: unknown } }"
    ],
    "passes": true,
    "notes": "Config defines disabled?: boolean explicitly. API response is loose typed but will include disabled from config. Other fields vary per provider."
  },
  {
    "category": "functional",
    "description": "Confirm runtime type includes `disabled` field for filtering",
    "steps": [
      "ProviderConfig.models[].variants[] explicitly defines disabled?: boolean",
      "Config values flow through to API response",
      "Filter pattern: Object.entries(variants).filter(([k, v]) => !v?.disabled)"
    ],
    "passes": true,
    "notes": "Confirmed. Use (variant as { disabled?: boolean }).disabled to access the field with type safety."
  },
  {
    "category": "functional",
    "description": "Verify `getOpencodeClientV2(directory)` returns typed client in `opencode.ts`",
    "steps": [
      "Verified function exists at opencode.ts:272-277",
      "Function signature: getOpencodeClientV2(directory: string): OpencodeClientV2 | null",
      "Type imported correctly from @opencode-ai/sdk/v2",
      "Already imported and used in session-handler.ts:10,255"
    ],
    "passes": true,
    "notes": "Function returns typed OpencodeClientV2 client from cached server map. Returns null if no server initialized for directory."
  },
  {
    "category": "functional",
    "description": "Confirm v2 `provider.list` exposes `models[].variants` as expected",
    "steps": [
      "Model type (lines 1636-1702) includes: variants?: { [key: string]: { [key: string]: unknown } }",
      "Provider type (lines 1703-1715) includes: models: { [key: string]: Model }",
      "provider.list returns Array<Provider>, each provider has models dict with Model values"
    ],
    "passes": true,
    "notes": "Confirmed via SDK types. Access pattern: provider.models[modelId].variants"
  },
  {
    "category": "functional",
    "description": "Confirm v2 `session.prompt` accepts `variant?: string` field",
    "steps": [
      "Read SDK type at node_modules/@opencode-ai/sdk/dist/v2/gen/sdk.gen.d.ts:408-424",
      "session.prompt accepts: sessionID, directory?, variant?, parts?, model?, agent?, system?, etc."
    ],
    "passes": true,
    "notes": "Confirmed in SDK types - variant?: string is supported in session.prompt parameters"
  },
  {
    "category": "functional",
    "description": "Confirm v2 `session.command` accepts `variant?: string` field",
    "steps": [
      "Read SDK type at node_modules/@opencode-ai/sdk/dist/v2/gen/sdk.gen.d.ts:462-479",
      "session.command accepts: sessionID, directory?, variant?, command?, arguments?, agent?, etc."
    ],
    "passes": true,
    "notes": "Confirmed in SDK types - variant?: string is supported in session.command parameters"
  },
  {
    "category": "functional",
    "description": "Note path parameter difference: v2 uses `sessionID`, v1 uses `id`",
    "steps": [
      "v1 style: getClient().session.prompt({ path: { id: ... }, body: { ... } })",
      "v2 style: clientV2.session.prompt({ sessionID: ..., ... }, { signal: ... })",
      "v2 uses flat parameters object, options object for signal/config"
    ],
    "passes": true,
    "notes": "Key migration difference documented - v2 uses flat sessionID parameter instead of nested path object"
  },
  {
    "category": "functional",
    "description": "Import `getOpencodeClientV2` in `discord/src/session-handler.ts`",
    "steps": [
      "Verified import at session-handler.ts:10",
      "Import: { initializeOpencodeForDirectory, getOpencodeServers, getOpencodeClientV2 } from './opencode.js'"
    ],
    "passes": true,
    "notes": "Import was already present"
  },
  {
    "category": "functional",
    "description": "Locate the `getClient().session.prompt` call in session-handler.ts",
    "steps": [
      "Found at line 686 (before migration)",
      "Was inside ternary for command vs prompt"
    ],
    "passes": true,
    "notes": "Located in processThreadRequest function"
  },
  {
    "category": "functional",
    "description": "Replace v1 `session.prompt` with v2 client call using `sessionID` path param",
    "steps": [
      "Replaced getClient().session.prompt with clientV2.session.prompt",
      "Changed from path: { id: session.id } to sessionID: session.id",
      "Added directory parameter for v2 API"
    ],
    "passes": true,
    "notes": "Migration complete at session-handler.ts:798"
  },
  {
    "category": "functional",
    "description": "Update prompt call to use flat parameter style instead of `path: { id: ... }`",
    "steps": [
      "Changed from { path: { id }, body: { parts, system, model, agent }, signal } to",
      "{ sessionID, directory, parts, system, model, agent }, { signal }"
    ],
    "passes": true,
    "notes": "v2 uses flat params in first arg, options (signal) in second arg"
  },
  {
    "category": "functional",
    "description": "Locate the `getClient().session.command` call in session-handler.ts",
    "steps": [
      "Found at line 677 (before migration)",
      "Was first branch of ternary for command vs prompt"
    ],
    "passes": true,
    "notes": "Located in processThreadRequest function"
  },
  {
    "category": "functional",
    "description": "Replace v1 `session.command` with v2 client call using `sessionID` path param",
    "steps": [
      "Replaced getClient().session.command with clientV2.session.command",
      "Changed from path: { id: session.id } to sessionID: session.id",
      "Added directory parameter for v2 API"
    ],
    "passes": true,
    "notes": "Migration complete at session-handler.ts:788"
  },
  {
    "category": "functional",
    "description": "Update command call to use flat parameter style instead of `path: { id: ... }`",
    "steps": [
      "Changed from { path: { id }, body: { command, arguments, agent }, signal } to",
      "{ sessionID, directory, command, arguments, agent }, { signal }"
    ],
    "passes": true,
    "notes": "v2 uses flat params in first arg, options (signal) in second arg"
  },
  {
    "category": "functional",
    "description": "Ensure model/agent fallback logic remains unchanged after migration",
    "steps": [
      "modelParam logic unchanged (lines 656-667)",
      "agentPreference logic unchanged (lines 669-673)",
      "Both still passed to v2 API calls"
    ],
    "passes": true,
    "notes": "Model/agent preference reading and fallback pattern preserved exactly"
  },
  {
    "category": "functional",
    "description": "Run `pnpm tsc` from `discord` directory to verify types compile",
    "steps": [
      "Ran `bun tsc --noEmit` in discord directory",
      "Only errors are pre-existing vitest import errors in .test.ts files",
      "All source code (non-test) compiles cleanly with v2 SDK migration"
    ],
    "passes": true,
    "notes": "Typecheck verified. Pre-existing test file errors (vitest not in deps) don't affect source. v2 migration types are correct."
  },
  {
    "category": "functional",
    "description": "Read `discord/src/commands/ask-question.ts` to understand current implementation",
    "steps": [
      "Read file to understand direct HTTP call at lines 214-221",
      "Found submitQuestionAnswers() uses fetch to /question/{requestID}/reply",
      "Uses getOpencodeServerPort() to construct URL"
    ],
    "passes": true,
    "notes": "File shows direct HTTP call pattern that bypasses typed SDK - migration target identified"
  },
  {
    "category": "functional",
    "description": "Import `getOpencodeClientV2` in ask-question.ts",
    "steps": [
      "Replaced getOpencodeServerPort import with getOpencodeClientV2",
      "Import from '../opencode.js' at line 13"
    ],
    "passes": true,
    "notes": "Import updated to use v2 SDK client"
  },
  {
    "category": "functional",
    "description": "Locate the direct HTTP call to `/question/{requestID}/reply`",
    "steps": [
      "Located in submitQuestionAnswers() function",
      "Was at lines 214-221 before migration"
    ],
    "passes": true,
    "notes": "Found in try block of submitQuestionAnswers"
  },
  {
    "category": "functional",
    "description": "Replace HTTP call with v2 SDK `clientV2.question.reply({ requestID, directory, answers })`",
    "steps": [
      "Replaced fetch() with clientV2.question.reply()",
      "Uses { requestID, directory, answers } flat params",
      "Error handling via { error } destructuring"
    ],
    "passes": true,
    "notes": "Migration complete at lines 210-224"
  },
  {
    "category": "functional",
    "description": "Remove `getOpencodeServerPort` import if no longer needed after migration",
    "steps": [
      "Removed getOpencodeServerPort import",
      "Added getOpencodeClientV2 import instead"
    ],
    "passes": true,
    "notes": "Import cleanup complete"
  },
  {
    "category": "functional",
    "description": "Test question tool flow manually end-to-end",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Open `discord/src/database.ts`",
    "steps": ["Read file to review existing structure and variant functions"],
    "passes": true,
    "notes": "File already has variant tables and helper functions from previous iteration"
  },
  {
    "category": "functional",
    "description": "Locate the `runModelMigrations` function",
    "steps": [
      "Found at lines 83-139, includes channel_variants and session_variants table creation"
    ],
    "passes": true,
    "notes": "Function already includes variant table migrations"
  },
  {
    "category": "functional",
    "description": "Add `channel_variants` table creation SQL:",
    "steps": [
      "Added CREATE TABLE IF NOT EXISTS channel_variants in runModelMigrations()"
    ],
    "passes": true,
    "notes": "Table stores channel_id (PK), variant_name, created_at, updated_at"
  },
  {
    "category": "functional",
    "description": "Add `session_variants` table creation SQL:",
    "steps": [
      "Added CREATE TABLE IF NOT EXISTS session_variants in runModelMigrations()"
    ],
    "passes": true,
    "notes": "Table stores session_id (PK), variant_name, created_at"
  },
  {
    "category": "functional",
    "description": "Add `getChannelVariant(channelId): string | undefined` function in database.ts",
    "steps": ["Implemented function that queries channel_variants table"],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Add `setChannelVariant(channelId, variantName): void` function in database.ts",
    "steps": ["Implemented with INSERT ... ON CONFLICT DO UPDATE pattern"],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Add `clearChannelVariant(channelId): void` function (DELETE FROM) in database.ts",
    "steps": ["Implemented DELETE FROM channel_variants WHERE channel_id = ?"],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Add `getSessionVariant(sessionId): string | undefined` function in database.ts",
    "steps": ["Implemented function that queries session_variants table"],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Add `setSessionVariant(sessionId, variantName): void` function in database.ts",
    "steps": ["Implemented with INSERT OR REPLACE pattern"],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Add `clearSessionVariant(sessionId): void` function (DELETE FROM) in database.ts",
    "steps": ["Implemented DELETE FROM session_variants WHERE session_id = ?"],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Export all new helper functions from database.ts",
    "steps": ["All functions are exported at module level"],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Ensure all new functions have proper error logging (no silent catches)",
    "steps": [
      "Functions use synchronous better-sqlite3 API which throws on error - no try/catch needed"
    ],
    "passes": true,
    "notes": "better-sqlite3 is synchronous and throws errors directly, consistent with existing code pattern"
  },
  {
    "category": "functional",
    "description": "Create new file `discord/src/commands/variant.ts`",
    "steps": ["Created file with full /variant command implementation"],
    "passes": true,
    "notes": "File created with handleVariantCommand and handleVariantSelectMenu functions"
  },
  {
    "category": "functional",
    "description": "Add imports: discord.js types, database helpers, opencode client, logger",
    "steps": ["Added imports at lines 4-30"],
    "passes": true,
    "notes": "Imports: discord.js, crypto, database helpers, opencode client, discord-utils, session-handler, logger"
  },
  {
    "category": "functional",
    "description": "Create `pendingVariantContexts` Map for storing pending selection contexts",
    "steps": ["Created Map at lines 34-44"],
    "passes": true,
    "notes": "Map stores dir, channelId, sessionId, isThread, thread, modelId"
  },
  {
    "category": "functional",
    "description": "Add TODO comment about TTL cleanup being technical debt",
    "steps": ["Added TODO comment at line 33"],
    "passes": true,
    "notes": "Comment: TODO: Add TTL cleanup - technical debt for memory management"
  },
  {
    "category": "functional",
    "description": "Create `handleVariantCommand` function with signature matching agent.ts pattern",
    "steps": ["Created function at lines 75-230"],
    "passes": true,
    "notes": "Function signature: handleVariantCommand({ interaction, appId })"
  },
  {
    "category": "functional",
    "description": "In handleVariantCommand: get channel ID and session ID from interaction",
    "steps": ["Implemented at lines 96-120"],
    "passes": true,
    "notes": "Handles threads vs text channels, queries thread_sessions table for sessionId"
  },
  {
    "category": "functional",
    "description": "In handleVariantCommand: look up current model preference (session then channel)",
    "steps": ["Implemented at lines 141-145"],
    "passes": true,
    "notes": "Uses getSessionModel() || getChannelModel() fallback pattern"
  },
  {
    "category": "functional",
    "description": "In handleVariantCommand: if no model set, reply \"No model preference set. Run `/model` first.\"",
    "steps": ["Implemented at lines 147-152"],
    "passes": true,
    "notes": "Returns early with user-friendly message"
  },
  {
    "category": "functional",
    "description": "In handleVariantCommand: fetch model metadata via v2 client to get variants",
    "steps": ["Implemented at lines 163-196"],
    "passes": true,
    "notes": "Uses clientV2.provider.list(), finds provider/model, accesses model.variants"
  },
  {
    "category": "functional",
    "description": "In handleVariantCommand: if no variants exist, reply \"No variants available for [model name].\"",
    "steps": ["Implemented at lines 198-203"],
    "passes": true,
    "notes": "Checks model.variants existence and length"
  },
  {
    "category": "functional",
    "description": "Create helper function to build variant options list from metadata",
    "steps": ["Created buildVariantOptions() at lines 46-72"],
    "passes": true,
    "notes": "Filters, sorts, limits, adds Default option"
  },
  {
    "category": "functional",
    "description": "In variant options helper: filter out variants where `disabled === true`",
    "steps": ["Implemented at lines 51-53"],
    "passes": true,
    "notes": "Uses .filter() with disabled check cast to { disabled?: boolean }"
  },
  {
    "category": "functional",
    "description": "In variant options helper: sort variants alphabetically by key name",
    "steps": ["Implemented at lines 54-56"],
    "passes": true,
    "notes": "Uses .sort() with localeCompare"
  },
  {
    "category": "functional",
    "description": "In variant options helper: take first 24 variants",
    "steps": ["Implemented at line 57"],
    "passes": true,
    "notes": "Uses .slice(0, 24) to leave room for Default option"
  },
  {
    "category": "functional",
    "description": "In variant options helper: add \"Default\" option at the end (value: `__default__`)",
    "steps": ["Implemented at lines 68-72"],
    "passes": true,
    "notes": "Adds { label: 'Default', value: '__default__', description: ... }"
  },
  {
    "category": "functional",
    "description": "In handleVariantCommand: create StringSelectMenuBuilder with variant options",
    "steps": ["Implemented at lines 215-219"],
    "passes": true,
    "notes": "Uses StringSelectMenuBuilder().setCustomId().setPlaceholder().addOptions()"
  },
  {
    "category": "functional",
    "description": "In handleVariantCommand: store context in `pendingVariantContexts` Map with hash key",
    "steps": ["Implemented at lines 205-213"],
    "passes": true,
    "notes": "Uses crypto.randomBytes(8).toString('hex') for hash"
  },
  {
    "category": "functional",
    "description": "In handleVariantCommand: send select menu to user with customId `variant_select:{hash}`",
    "steps": ["Implemented at lines 215-226"],
    "passes": true,
    "notes": "customId format: variant_select:{contextHash}"
  },
  {
    "category": "functional",
    "description": "Create `handleVariantSelectMenu` function in variant.ts",
    "steps": ["Created function at lines 235-316"],
    "passes": true,
    "notes": "Handles StringSelectMenuInteraction for variant selection"
  },
  {
    "category": "functional",
    "description": "In handleVariantSelectMenu: extract context hash from customId",
    "steps": ["Implemented at line 244"],
    "passes": true,
    "notes": "Uses customId.replace('variant_select:', '')"
  },
  {
    "category": "functional",
    "description": "In handleVariantSelectMenu: retrieve context from `pendingVariantContexts` Map",
    "steps": ["Implemented at line 245"],
    "passes": true,
    "notes": "Uses pendingVariantContexts.get(contextHash)"
  },
  {
    "category": "functional",
    "description": "In handleVariantSelectMenu: if no context found, reply with error",
    "steps": ["Implemented at lines 247-253"],
    "passes": true,
    "notes": "Returns 'Selection expired. Please run /variant again.'"
  },
  {
    "category": "functional",
    "description": "In handleVariantSelectMenu: get selected variant value from interaction",
    "steps": ["Implemented at line 255"],
    "passes": true,
    "notes": "Uses interaction.values[0]"
  },
  {
    "category": "functional",
    "description": "In handleVariantSelectMenu: determine scope (session or channel) from context",
    "steps": ["Implemented at lines 266, 295"],
    "passes": true,
    "notes": "Checks context.isThread && context.sessionId for session scope"
  },
  {
    "category": "functional",
    "description": "In handleVariantSelectMenu: if \"Default\" selected (`__default__`), call `clearSessionVariant` or `clearChannelVariant`",
    "steps": ["Implemented at lines 268-270, 296-298"],
    "passes": true,
    "notes": "Checks isDefault = selectedVariant === '__default__'"
  },
  {
    "category": "functional",
    "description": "In handleVariantSelectMenu: otherwise, call `setSessionVariant` or `setChannelVariant`",
    "steps": ["Implemented at lines 272-276, 300-304"],
    "passes": true,
    "notes": "Uses setSessionVariant/setChannelVariant from database.js"
  },
  {
    "category": "functional",
    "description": "In handleVariantSelectMenu: call `abortAndRetrySession` to apply immediately",
    "steps": ["Implemented at lines 279-284"],
    "passes": true,
    "notes": "Only for session scope when thread exists"
  },
  {
    "category": "functional",
    "description": "In handleVariantSelectMenu: send confirmation message with variant name",
    "steps": ["Implemented at lines 286-293, 306-311"],
    "passes": true,
    "notes": "Shows variant name with retry message if applicable"
  },
  {
    "category": "functional",
    "description": "Export `handleVariantCommand` and `handleVariantSelectMenu` from variant.ts",
    "steps": ["Both functions exported at module level"],
    "passes": true,
    "notes": "Export via function declaration (export async function ...)"
  },
  {
    "category": "functional",
    "description": "Open `discord/src/commands/model.ts`",
    "steps": ["Read file to understand current v1 implementation"],
    "passes": true,
    "notes": "File uses v1 getClient().provider.list in handleModelCommand (line 129) and handleProviderSelectMenu (line 233)"
  },
  {
    "category": "functional",
    "description": "Import `getOpencodeClientV2` from opencode.ts",
    "steps": ["Added import from '../opencode.js'"],
    "passes": true,
    "notes": "Import added at line 21 alongside initializeOpencodeForDirectory"
  },
  {
    "category": "functional",
    "description": "Locate the v1 `getClient().provider.list` call",
    "steps": [
      "Found two calls: handleModelCommand (line 129) and handleProviderSelectMenu (line 233)"
    ],
    "passes": true,
    "notes": "Both used v1 style: getClient().provider.list({ query: { directory } })"
  },
  {
    "category": "functional",
    "description": "Replace with v2 client call: `clientV2.provider.list({ directory })`",
    "steps": [
      "Replaced both v1 calls with v2 pattern",
      "handleModelCommand: lines 138-151",
      "handleProviderSelectMenu: lines 257-271",
      "Uses { data, error } destructuring pattern"
    ],
    "passes": true,
    "notes": "v2 uses flat params: clientV2.provider.list({ directory }) - no nested query object"
  },
  {
    "category": "functional",
    "description": "Update any type references for the provider response",
    "steps": [
      "Changed providersResponse.data to providersData (destructured)",
      "Added error handling via providersError"
    ],
    "passes": true,
    "notes": "v2 response structure: { data, error } - data contains { all, connected }"
  },
  {
    "category": "functional",
    "description": "Ensure provider/model selection logic works with v2 response structure",
    "steps": [
      "Verified providersData.all and providersData.connected access patterns",
      "Provider models access (provider.models) unchanged",
      "Typecheck passes for source code"
    ],
    "passes": true,
    "notes": "v2 provider response structure matches v1 data structure - only wrapper changed"
  },
  {
    "category": "functional",
    "description": "In model.ts: create `pendingModelVariantContexts` Map for variant selection contexts",
    "steps": [
      "Added Map at lines 47-62 in model.ts",
      "Stores dir, channelId, sessionId, isThread, providerId, providerName, modelId, modelName, thread"
    ],
    "passes": true,
    "notes": "Map stores full context needed to persist model+variant after selection"
  },
  {
    "category": "functional",
    "description": "In model.ts: add TODO comment about TTL cleanup being technical debt",
    "steps": [
      "Added TODO comment at line 48: 'TODO: Add TTL cleanup - technical debt for memory management'"
    ],
    "passes": true,
    "notes": "Comment added above pendingModelVariantContexts Map"
  },
  {
    "category": "functional",
    "description": "In `handleModelSelectMenu`: after model is selected, fetch model metadata via v2",
    "steps": [
      "Added clientV2.provider.list() call at lines 456-475",
      "Fetches providers to access selected model's variants"
    ],
    "passes": true,
    "notes": "Uses existing getOpencodeClientV2 pattern"
  },
  {
    "category": "functional",
    "description": "In `handleModelSelectMenu`: check if selected model has variants",
    "steps": [
      "Added variant check at lines 480-484",
      "Checks model?.variants and Object.keys length"
    ],
    "passes": true,
    "notes": "Uses buildVariantOptions to get enabled variants count"
  },
  {
    "category": "functional",
    "description": "In `handleModelSelectMenu`: if no variants, persist model immediately",
    "steps": [
      "Implemented at lines 511-547",
      "Stores model via setSessionModel/setChannelModel when no variants"
    ],
    "passes": true,
    "notes": "Falls through to persist when hasEnabledVariants is false"
  },
  {
    "category": "functional",
    "description": "In `handleModelSelectMenu`: if no variants, call `clearSessionVariant` or `clearChannelVariant` to clear old variant",
    "steps": [
      "Added clearSessionVariant at line 513",
      "Added clearChannelVariant at line 532"
    ],
    "passes": true,
    "notes": "Clears old variant when switching to model without variants"
  },
  {
    "category": "functional",
    "description": "In `handleModelSelectMenu`: if variants exist, build variant picker (reuse logic from variant.ts)",
    "steps": [
      "Added buildVariantOptions helper at lines 77-112",
      "Same pattern as variant.ts - filters disabled, sorts, limits to 24, adds Default"
    ],
    "passes": true,
    "notes": "Helper function duplicated to avoid cross-module dependency"
  },
  {
    "category": "functional",
    "description": "In `handleModelSelectMenu`: store context with providerId, providerName, modelId in Map",
    "steps": [
      "Stores context in pendingModelVariantContexts at lines 488-499",
      "Includes all required fields for variant selection persistence"
    ],
    "passes": true,
    "notes": "Context includes modelName for display in confirmation message"
  },
  {
    "category": "functional",
    "description": "In `handleModelSelectMenu`: show variant picker with customId `model_variant:{hash}`",
    "steps": [
      "Creates StringSelectMenuBuilder at lines 501-504",
      "Uses customId format model_variant:{contextHash}"
    ],
    "passes": true,
    "notes": "Variant picker shown with context hash for lookup"
  },
  {
    "category": "functional",
    "description": "In `handleModelSelectMenu`: only persist model+variant after variant selection",
    "steps": [
      "Model is NOT persisted when variants exist - returns early at line 510",
      "Persistence happens in handleModelVariantSelectMenu instead"
    ],
    "passes": true,
    "notes": "Model selection flow continues to variant selection before persisting"
  },
  {
    "category": "functional",
    "description": "Create `handleModelVariantSelectMenu` function in model.ts",
    "steps": [
      "Created function at lines 558-628",
      "Handles model_variant: customId prefix"
    ],
    "passes": true,
    "notes": "Function signature matches handleVariantSelectMenu pattern"
  },
  {
    "category": "functional",
    "description": "In handleModelVariantSelectMenu: extract context hash from customId",
    "steps": [
      "Extracts hash at line 566: customId.replace('model_variant:', '')"
    ],
    "passes": true,
    "notes": "Same pattern as other select menu handlers"
  },
  {
    "category": "functional",
    "description": "In handleModelVariantSelectMenu: retrieve context from `pendingModelVariantContexts` Map",
    "steps": [
      "Retrieves context at line 567: pendingModelVariantContexts.get(contextHash)"
    ],
    "passes": true,
    "notes": "Returns full context needed for persistence"
  },
  {
    "category": "functional",
    "description": "In handleModelVariantSelectMenu: if no context found, reply with error",
    "steps": [
      "Error handling at lines 569-575",
      "Returns 'Selection expired. Please run /model again.'"
    ],
    "passes": true,
    "notes": "Handles expired/missing context gracefully"
  },
  {
    "category": "functional",
    "description": "In handleModelVariantSelectMenu: get selected variant value from interaction",
    "steps": ["Gets value at line 577: interaction.values[0]"],
    "passes": true,
    "notes": "Same pattern as other select handlers"
  },
  {
    "category": "functional",
    "description": "In handleModelVariantSelectMenu: persist model preference (existing logic)",
    "steps": [
      "Persists model at lines 590, 609: setSessionModel/setChannelModel"
    ],
    "passes": true,
    "notes": "Uses existing database helpers"
  },
  {
    "category": "functional",
    "description": "In handleModelVariantSelectMenu: if \"Default\" selected, call clear variant helper",
    "steps": [
      "Checks isDefault at line 586: selectedVariant === '__default__'",
      "Calls clearSessionVariant at line 592 or clearChannelVariant at line 612"
    ],
    "passes": true,
    "notes": "Clears variant when Default is selected"
  },
  {
    "category": "functional",
    "description": "In handleModelVariantSelectMenu: otherwise, call set variant helper",
    "steps": [
      "Calls setSessionVariant at line 594 or setChannelVariant at line 614"
    ],
    "passes": true,
    "notes": "Sets variant when non-default selected"
  },
  {
    "category": "functional",
    "description": "In handleModelVariantSelectMenu: call `abortAndRetrySession` to apply immediately",
    "steps": ["Calls abortAndRetrySession at lines 599-604 for session scope"],
    "passes": true,
    "notes": "Only for session scope when thread exists"
  },
  {
    "category": "functional",
    "description": "In handleModelVariantSelectMenu: send confirmation message including variant in format: \"**Provider** / **Model** / **Variant**\"",
    "steps": [
      "Confirmation at lines 606-608, 617-619",
      "Format: **providerName** / **modelName** / **variantDisplay**"
    ],
    "passes": true,
    "notes": "Shows full path: Provider / Model / Variant"
  },
  {
    "category": "functional",
    "description": "Export `handleModelVariantSelectMenu` from model.ts",
    "steps": ["Function exported via 'export async function' declaration"],
    "passes": true,
    "notes": "Exported at module level"
  },
  {
    "category": "functional",
    "description": "Open `discord/src/session-handler.ts`",
    "steps": ["Read file to understand current implementation"],
    "passes": true,
    "notes": "File already has v2 client calls at lines 797-818, model/agent preference pattern at lines 761-783"
  },
  {
    "category": "functional",
    "description": "Import `getSessionVariant` and `getChannelVariant` from database.ts",
    "steps": [
      "Added imports to existing database.js import block at lines 10-17"
    ],
    "passes": true,
    "notes": "Added getSessionVariant and getChannelVariant to the import list"
  },
  {
    "category": "functional",
    "description": "Locate where model preference is read (session then channel fallback)",
    "steps": ["Found at lines 761-775 in processThreadRequest"],
    "passes": true,
    "notes": "Pattern: getSessionModel(session.id) || (channelId ? getChannelModel(channelId) : undefined)"
  },
  {
    "category": "functional",
    "description": "Add variant preference reading with same fallback pattern:",
    "steps": [
      "Added variantPreference variable following same pattern after agentPreference block"
    ],
    "passes": true,
    "notes": "getSessionVariant(session.id) || (channelId ? getChannelVariant(channelId) : undefined)"
  },
  {
    "category": "functional",
    "description": "Locate the v2 `session.prompt` call",
    "steps": ["Found at lines 808-818 in processThreadRequest"],
    "passes": true,
    "notes": "Located in ternary, second branch (non-command case)"
  },
  {
    "category": "functional",
    "description": "Add `variant: variantPreference` to the prompt call when present",
    "steps": [
      "Added variant: variantPreference to session.prompt params object"
    ],
    "passes": true,
    "notes": "v2 SDK accepts undefined gracefully - no conditional needed"
  },
  {
    "category": "functional",
    "description": "Locate the v2 `session.command` call",
    "steps": ["Found at lines 798-807 in processThreadRequest"],
    "passes": true,
    "notes": "Located in ternary, first branch (command case)"
  },
  {
    "category": "functional",
    "description": "Add `variant: variantPreference` to the command call when present",
    "steps": [
      "Added variant: variantPreference to session.command params object"
    ],
    "passes": true,
    "notes": "v2 SDK accepts undefined gracefully - no conditional needed"
  },
  {
    "category": "functional",
    "description": "Add log statement: `sessionLogger.log('[VARIANT] Using variant: ${variantPreference}')`",
    "steps": ["Added conditional log statement after variantPreference is set"],
    "passes": true,
    "notes": "Only logs when variantPreference is truthy, consistent with agent logging pattern"
  },
  {
    "category": "functional",
    "description": "Open `discord/src/cli.ts`",
    "steps": ["Read file to find registerCommands function"],
    "passes": true,
    "notes": "File read, slash commands array located at lines 192-320"
  },
  {
    "category": "functional",
    "description": "Locate where slash commands are registered (array of SlashCommandBuilder)",
    "steps": [
      "Found commands array at lines 192-320 in registerCommands function"
    ],
    "passes": true,
    "notes": "Array of SlashCommandBuilder objects, new commands added after 'agent' command"
  },
  {
    "category": "functional",
    "description": "Add new slash command:",
    "steps": [
      "Added SlashCommandBuilder for /variant after /agent command",
      "Description: 'Set the model variant for this channel or session'"
    ],
    "passes": true,
    "notes": "Added at line 294 in cli.ts"
  },
  {
    "category": "functional",
    "description": "Open `discord/src/interaction-handler.ts`",
    "steps": ["Read file to understand routing structure"],
    "passes": true,
    "notes": "File uses switch statements for commands and if/startsWith for select menus"
  },
  {
    "category": "functional",
    "description": "Import `handleVariantCommand` from `./commands/variant.js`",
    "steps": ["Added import at line 16 alongside handleAgentCommand"],
    "passes": true,
    "notes": "Import: { handleVariantCommand, handleVariantSelectMenu } from './commands/variant.js'"
  },
  {
    "category": "functional",
    "description": "Import `handleVariantSelectMenu` from `./commands/variant.js`",
    "steps": ["Added in same import statement as handleVariantCommand"],
    "passes": true,
    "notes": "Combined import for both functions"
  },
  {
    "category": "functional",
    "description": "Import `handleModelVariantSelectMenu` from `./commands/model.js`",
    "steps": [
      "Added to import at lines 26-31 in interaction-handler.ts",
      "Import: { handleModelCommand, handleProviderSelectMenu, handleModelSelectMenu, handleModelVariantSelectMenu }"
    ],
    "passes": true,
    "notes": "Added to existing model.js import block"
  },
  {
    "category": "functional",
    "description": "Locate the command switch statement",
    "steps": ["Found at lines 71-133 in registerInteractionHandler"],
    "passes": true,
    "notes": "Switch on interaction.commandName"
  },
  {
    "category": "functional",
    "description": "Add case for 'variant' command:",
    "steps": [
      "Added case 'variant': at line 118",
      "Calls handleVariantCommand({ interaction, appId })"
    ],
    "passes": true,
    "notes": "Added after 'agent' case, before 'queue' case"
  },
  {
    "category": "functional",
    "description": "Locate where select menu interactions are routed (customId checks)",
    "steps": ["Found at lines 143-171 in isStringSelectMenu block"],
    "passes": true,
    "notes": "Uses customId.startsWith() pattern for routing"
  },
  {
    "category": "functional",
    "description": "Add routing for `variant_select:` prefix:",
    "steps": [
      "Added if block at lines 171-175",
      "Checks customId.startsWith('variant_select:')",
      "Calls handleVariantSelectMenu(interaction)"
    ],
    "passes": true,
    "notes": "Added after ask_question handler"
  },
  {
    "category": "functional",
    "description": "Add routing for `model_variant:` prefix:",
    "steps": [
      "Added if block at lines 191-195 in interaction-handler.ts",
      "Checks customId.startsWith('model_variant:')",
      "Calls handleModelVariantSelectMenu(interaction)"
    ],
    "passes": true,
    "notes": "Added after model_select handler"
  },
  {
    "category": "functional",
    "description": "Run `pnpm tsc` from `discord` directory - full project typecheck",
    "steps": [
      "Ran bun tsc --noEmit in discord directory",
      "Source code compiles clean",
      "Only errors are pre-existing vitest import errors in test files"
    ],
    "passes": true,
    "notes": "Typecheck verified. Pre-existing test file errors (vitest not in deps) don't affect source."
  },
  {
    "category": "functional",
    "description": "Fix any remaining type errors",
    "steps": [
      "Fixed type error at line 484: changed model.variants to variants variable",
      "TypeScript narrowing now works correctly with extracted variable"
    ],
    "passes": true,
    "notes": "No remaining type errors in source code"
  },
  {
    "category": "functional",
    "description": "Review all new code for silent catch blocks - add logging where missing",
    "steps": [
      "Identified catch blocks in new files: variant.ts (2), model.ts (4 total, 1 new)",
      "variant.ts:267 - variantLogger.error('Error loading variants:', error) - OK",
      "variant.ts:367 - variantLogger.error('Error saving variant preference:', error) - OK",
      "model.ts:269 - modelLogger.error('Error loading providers:', error) - OK",
      "model.ts:401 - modelLogger.error('Error loading models:', error) - OK",
      "model.ts:563 - modelLogger.error('Error saving model preference:', error) - OK",
      "model.ts:663 - modelLogger.error('Error saving model+variant preference:', error) - OK"
    ],
    "passes": true,
    "notes": "All catch blocks in new variant feature code have proper logging via variantLogger/modelLogger. No silent suppression found."
  },
  {
    "category": "functional",
    "description": "Verify all new functions are properly exported",
    "steps": [
      "Verified variant.ts exports: handleVariantCommand (line 88), handleVariantSelectMenu (line 279)",
      "Verified model.ts exports: handleModelCommand (117), handleProviderSelectMenu (281), handleModelSelectMenu (414), handleModelVariantSelectMenu (576)",
      "Verified database.ts exports all 6 variant helpers: get/set/clearChannelVariant, get/set/clearSessionVariant",
      "Verified interaction-handler.ts imports: all handlers imported at lines 26-36",
      "Verified interaction-handler.ts routing: variant handlers called at lines 147, 194, 209"
    ],
    "passes": true,
    "notes": "All new functions properly exported and imported. Typecheck passes (pre-existing vitest errors in test files only)."
  },
  {
    "category": "functional",
    "description": "Test `/model` shows provider → model → variant flow when variants exist",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Test `/model` for a model without variants clears any stored variant",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Test `/variant` shows variants for active model",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Test `/variant` when no model set shows error message",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Test selecting \"Default\" clears stored variant preference",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Test session-level variant overrides channel-level variant",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Test `/variant` during active request aborts and retries with new variant",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Verify variant field is included in prompt/command API calls via logs",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Test variant list respects 24+Default limit",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Test disabled variants are filtered out",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Test ask question tool works end-to-end with v2 SDK",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Add TTL cleanup for pending context Maps across all commands",
    "steps": [
      "Added createdAt field to all pending context types",
      "Added PENDING_CONTEXT_TTL_MS = 5 * 60 * 1000 (5 minutes)",
      "Added cleanupExpiredContexts() function to variant.ts, model.ts, agent.ts",
      "Call cleanupExpiredContexts() before adding new contexts",
      "Added expiration check when retrieving contexts (delete if expired)",
      "Files modified: variant.ts, model.ts, agent.ts"
    ],
    "passes": true,
    "notes": "TTL cleanup prevents unbounded memory growth from abandoned select menus. Cleanup runs on new context creation and retrieval. 5-minute TTL is generous for Discord interactions."
  },
  {
    "category": "functional",
    "description": "Consider migrating `discord/src/markdown.ts` to v2 clients for consistency",
    "steps": ["Add verification steps for this item."],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Write tests for variant preference helper functions",
    "steps": [
      "Created discord/src/database-variants.test.ts with 13 tests",
      "Tests use bun:sqlite (bun-compatible) instead of better-sqlite3 (not supported in bun)",
      "Tests cover: getChannelVariant, setChannelVariant, clearChannelVariant",
      "Tests cover: getSessionVariant, setSessionVariant, clearSessionVariant",
      "Tests verify: roundtrip get/set, update behavior, clear behavior, idempotent clears",
      "Tests verify: table schema (columns, primary keys), migration idempotency",
      "All 13 tests pass: bun test src/database-variants.test.ts --run"
    ],
    "passes": true,
    "notes": "Tests validate SQL patterns used in database.ts. Uses in-memory bun:sqlite to test schema and CRUD without touching real database. Pre-existing test file issues (vitest imports, snapshot mismatches) are unrelated to this change."
  }
]
